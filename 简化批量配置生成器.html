<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€åŒ–æ‰¹é‡é…ç½®ç”Ÿæˆå™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .section h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        textarea {
            width: 100%;
            height: 150px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            resize: vertical;
        }

        input[type="text"],
        input[type="number"] {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 5px 0;
            font-size: 14px;
        }

        .btn {
            padding: 12px 30px;
            font-size: 16px;
            cursor: pointer;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            margin: 10px 5px;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #5568d3;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #219150;
        }

        .btn-warning {
            background: #f39c12;
        }

        .btn-warning:hover {
            background: #e67e22;
        }

        textarea#outputCode {
            height: 400px;
            background: #2d2d2d;
            color: #f8f8f2;
        }

        .info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #2196f3;
        }

        .warning {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #ffc107;
        }

        .success {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #4caf50;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }

        th {
            background: #667eea;
            color: white;
        }

        tr:nth-child(even) {
            background: #f9f9f9;
        }

        .batch-add {
            background: #e8f5e9;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .batch-add label {
            display: block;
            margin: 10px 0 5px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>ğŸ“¦ ç®€åŒ–æ‰¹é‡é…ç½®ç”Ÿæˆå™¨</h1>

    <div class="container">
        <div class="info">
            <strong>ç®€åŒ–è¯´æ˜ï¼š</strong>
            <p>ç³»ç»Ÿå·²ç®€åŒ–ï¼Œåªéœ€é…ç½®ç®±å­å·åˆ—è¡¨ã€‚è‡ªåŠ¨æ”¯æŒå¤šæ ¼å¼å›¾ç‰‡ï¼ˆ.jpg, .png, .webpç­‰ï¼‰ã€‚</p>
        </div>

        <!-- æ–¹æ³•ä¸€ï¼šæ‰‹åŠ¨è¾“å…¥ç®±å­å· -->
        <div class="section">
            <h3>ğŸ“ æ–¹æ³•ä¸€ï¼šæ‰‹åŠ¨è¾“å…¥ç®±å­å·åˆ—è¡¨</h3>
            <p>æ¯è¡Œä¸€ä¸ªç®±å­å·ï¼Œæ”¯æŒæ‰¹é‡ç²˜è´´ï¼š</p>
            <textarea id="boxNumbersInput" placeholder="CMEX-001&#10;CMEX-002&#10;CMEX-003&#10;..."></textarea>
            <br>
            <button class="btn" onclick="generateFromText()">ç”Ÿæˆé…ç½®</button>
        </div>

        <!-- æ–¹æ³•äºŒï¼šæ‰¹é‡æ·»åŠ ç›¸åŒäº§å“å¤šç®± -->
        <div class="section">
            <h3>ğŸ”„ æ–¹æ³•äºŒï¼šæ‰¹é‡æ·»åŠ ç›¸åŒäº§å“çš„å¤šç®±ï¼ˆæ¨èï¼‰</h3>
            <p>ä¾‹å¦‚ï¼šä¸€æ¬¾äº§å“è£…äº†10ç®±ï¼Œåªéœ€é…ç½®ä¸€æ¬¡ï¼š</p>

            <div class="batch-add">
                <label>ç®±å­å‰ç¼€ï¼ˆå¦‚ï¼šCMEX-ï¼‰ï¼š</label>
                <input type="text" id="boxPrefix" value="CMEX-" style="width: 200px;">

                <label>èµ·å§‹ç¼–å·ï¼š</label>
                <input type="number" id="startNumber" value="1" style="width: 100px;">

                <label>ç»“æŸç¼–å·ï¼š</label>
                <input type="number" id="endNumber" value="10" style="width: 100px;">

                <label>ç¼–å·ä½æ•°ï¼ˆ3ä½ï¼š001ï¼Œ2ä½ï¼š01ï¼‰ï¼š</label>
                <input type="number" id="digitCount" value="3" style="width: 100px;">

                <label>å›¾ç‰‡æ˜ å°„æ–¹å¼ï¼š</label>
                <select id="imageMappingType" style="padding: 10px; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 10px;">
                    <option value="same">å…¨éƒ¨ä½¿ç”¨ç¬¬ä¸€å¼ å›¾ç‰‡ï¼ˆæœ€çœï¼‰</option>
                    <option value="manual">æ‰‹åŠ¨æŒ‡å®šæ˜ å°„ï¼ˆæ¨èï¼Œçµæ´»ï¼‰</option>
                    <option value="individual">æ¯ä¸ªç®±å­ç‹¬ç«‹å›¾ç‰‡</option>
                </select>

                <div id="imageGroupSettings" style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 10px 0; display: none;">
                    <label style="color: #1976d2;">ğŸ“¦ æŒ‰è¿ç»­èŒƒå›´åˆ†ç»„ï¼ˆæ—§æ–¹å¼ï¼‰ï¼š</label>
                    <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
                        ä¾‹å¦‚ï¼š1-5ç®±ç”¨ç¬¬1å¼ å›¾ï¼Œ6-10ç®±ç”¨ç¬¬2å¼ å›¾
                    </p>
                    <textarea id="imageGroupConfig" style="height: 100px; font-size: 12px;" placeholder="æ¯è¡Œä¸€ä¸ªç»„ï¼Œæ ¼å¼ï¼šèµ·å§‹-ç»“æŸ&#10;1-5&#10;6-10&#10;11-20">1-5
6-10</textarea>
                </div>

                <div id="manualMappingSettings" style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 10px 0;">
                    <label style="color: #f57c00;">ğŸ“¦ æ‰‹åŠ¨æŒ‡å®šæ˜ å°„ï¼ˆæ¨èï¼‰ï¼š</label>
                    <p style="font-size: 12px; color: #666; margin-bottom: 10px;">
                        ä¾‹å¦‚ï¼šAäº§å“3ç®±ã€Bäº§å“5ç®±ã€Cäº§å“2ç®±ï¼Œä¸å‡åŒ€åˆ†é…
                    </p>
                    <textarea id="manualMappingConfig" style="height: 200px; font-size: 12px;" placeholder="æ¯è¡Œæ ¼å¼ï¼šç®±å­å·=å›¾ç‰‡æ–‡ä»¶å&#10;ä¾‹å¦‚ï¼š&#10;CMEX-001=CMEX-001&#10;CMEX-002=CMEX-001&#10;CMEX-003=CMEX-001&#10;CMEX-004=CMEX-004&#10;CMEX-005=CMEX-004&#10;CMEX-006=CMEX-004&#10;CMEX-007=CMEX-004&#10;CMEX-008=CMEX-004&#10;CMEX-009=CMEX-009&#10;CMEX-010=CMEX-009&#10;&#10;è¯´æ˜ï¼š&#10;- ç®±å­å·=å›¾ç‰‡æ–‡ä»¶å è¡¨ç¤ºè¯¥ç®±å­ä½¿ç”¨æŒ‡å®šå›¾ç‰‡&#10;- å¯ä»¥å¤šä¸ªç®±å­æŒ‡å‘åŒä¸€å¼ å›¾ç‰‡ï¼ˆå¦‚CMEX-002å’ŒCMEX-003éƒ½ç”¨CMEX-001ï¼‰&#10;- ä¸éœ€è¦è¿ç»­ç¼–å·ï¼Œå¯ä»¥éšæ„æŒ‡å®šä»»æ„ç®±å­çš„æ˜ å°„&#10;- å›¾ç‰‡æ–‡ä»¶åä¸éœ€è¦æ‰©å±•åï¼ˆè‡ªåŠ¨å°è¯•.jpg/.png/.webpï¼‰"></textarea>
                    <div style="margin-top: 10px;">
                        <button class="btn" onclick="autoFillMapping()">âœ¨ è‡ªåŠ¨å¡«å……ç¤ºä¾‹</button>
                        <span style="font-size: 12px; color: #666; margin-left: 10px;">ï¼ˆå°†è‡ªåŠ¨ä¸ºå½“å‰èŒƒå›´å†…çš„ç®±å­ç”Ÿæˆç¤ºä¾‹æ˜ å°„ï¼šå‰3ç®±ç”¨ç¬¬1å¼ å›¾ï¼Œä¸­é—´5ç®±ç”¨ç¬¬4å¼ å›¾ï¼Œå‰©ä½™ç”¨ç¬¬9å¼ å›¾ï¼‰</span>
                    </div>
                </div>

                <br>
                <button class="btn btn-success" onclick="generateBatch()">ç”Ÿæˆæ‰¹æ¬¡é…ç½®</button>
            </div>
        </div>

        <!-- æ–¹æ³•ä¸‰ï¼šå¤šä¸ªæ‰¹æ¬¡ -->
        <div class="section">
            <h3>ğŸ“¦ æ–¹æ³•ä¸‰ï¼šç®¡ç†å¤šä¸ªäº§å“æ‰¹æ¬¡</h3>
            <p>ä¸ºä¸åŒäº§å“åˆ›å»ºå¤šä¸ªæ‰¹æ¬¡ï¼Œæœ€ååˆå¹¶ï¼š</p>

            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 10px 0;">
                <strong>æ‰¹æ¬¡ç®¡ç†ï¼š</strong>
                <div id="batchList" style="margin: 15px 0;">
                    <p>æš‚æ— æ‰¹æ¬¡</p>
                </div>
                <button class="btn" onclick="showBatchInput()">æ·»åŠ æ–°æ‰¹æ¬¡</button>
                <button class="btn btn-warning" onclick="clearBatches()">æ¸…ç©ºæ‰€æœ‰æ‰¹æ¬¡</button>
                <button class="btn btn-success" onclick="mergeBatches()">åˆå¹¶æ‰€æœ‰æ‰¹æ¬¡</button>
            </div>
        </div>

        <!-- æ–¹æ³•å››ï¼šäº§å“è´§å·æ˜ å°„ï¼ˆæœ€ç›´è§‚ï¼‰ -->
        <div class="section">
            <h3>ğŸ·ï¸ æ–¹æ³•å››ï¼šäº§å“è´§å·æ˜ å°„ï¼ˆæ¨èï¼‰</h3>
            <p>å°†ç®±å­å·æ˜ å°„åˆ°äº§å“è´§å·ï¼Œåªéœ€å‡†å¤‡äº§å“è´§å·çš„å›¾ç‰‡æ–‡ä»¶ï¼š</p>

            <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 10px 0;">
                <!-- äº§å“æ‰¹æ¬¡ç®¡ç† -->
                <div style="margin-bottom: 15px;">
                    <label style="font-weight: bold;">ç¬¬ä¸€æ­¥ï¼šæ·»åŠ äº§å“æ‰¹æ¬¡</label>
                    <p style="font-size: 12px; color: #666; margin: 5px 0;">
                        æ¯ä¸ªæ‰¹æ¬¡å¯¹åº”ä¸€ä¸ªäº§å“ï¼Œä¸€æ‰¹è´§æœ‰å¤šä¸ªäº§å“å°±æ·»åŠ å¤šä¸ªæ‰¹æ¬¡
                    </p>

                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 10px 0;">
                        <div style="margin-bottom: 10px;">
                            <label style="font-weight: bold;">æ‰¹æ¬¡é…ç½®ï¼š</label>
                        </div>

                        <div style="margin-top: 10px;">
                            <label>äº§å“è´§å·ï¼š</label>
                            <input type="text" id="productCode" placeholder="1169" style="width: 100px;">

                            <label>ç®±å­å‰ç¼€ï¼š</label>
                            <input type="text" id="boxPrefix4" value="CMEX-" style="width: 80px;">

                            <label>èµ·å§‹ç¼–å·ï¼š</label>
                            <input type="number" id="startNumber4" value="1" style="width: 70px;">

                            <label>ç»“æŸç¼–å·ï¼š</label>
                            <input type="number" id="endNumber4" value="3" style="width: 70px;">

                            <label>ç¼–å·ä½æ•°ï¼š</label>
                            <input type="number" id="digitCount4" value="3" style="width: 60px;">

                            <button class="btn btn-success" onclick="addProductBatch()">+ æ·»åŠ æ‰¹æ¬¡</button>
                        </div>

                        <div id="productBatchList" style="margin-top: 15px;">
                            <p style="font-size: 12px; color: #999;">æš‚æ— æ‰¹æ¬¡</p>
                        </div>

                        <div style="margin-top: 10px;">
                            <button class="btn btn-warning" onclick="clearProductBatches()">æ¸…ç©ºæ‰€æœ‰æ‰¹æ¬¡</button>
                            <button class="btn" onclick="autoFillProductBatches()">âœ¨ è‡ªåŠ¨å¡«å……ç¤ºä¾‹</button>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 15px;">
                    <label style="font-weight: bold;">ç¬¬äºŒæ­¥ï¼šç”Ÿæˆé…ç½®</label>
                    <div style="margin-top: 10px;">
                        <button class="btn btn-success" style="font-size: 16px; padding: 12px 24px;" onclick="generateProductMappingFromBatches()">ğŸ“¦ ç”Ÿæˆäº§å“è´§å·æ˜ å°„é…ç½®</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¾“å‡ºç»“æœ -->
        <div class="section">
            <h3>ğŸ“¤ ç”Ÿæˆçš„é…ç½®ä»£ç </h3>
            <textarea id="outputCode" readonly placeholder="é…ç½®ä»£ç å°†åœ¨è¿™é‡Œç”Ÿæˆ..."></textarea>
            <br>
            <button class="btn btn-success" onclick="copyCode()">ğŸ“‹ å¤åˆ¶é…ç½®ä»£ç </button>
            <button class="btn" onclick="downloadCode()">â¬‡ï¸ ä¸‹è½½é…ç½®æ–‡ä»¶</button>
            <button class="btn" onclick="clearOutput()">ğŸ—‘ï¸ æ¸…ç©ºè¾“å‡º</button>
        </div>

        <!-- é¢„è§ˆè¡¨æ ¼ -->
        <div class="section" id="previewSection" style="display: none;">
            <h3>ğŸ“Š é…ç½®é¢„è§ˆ</h3>
            <table>
                <thead>
                    <tr>
                        <th>åºå·</th>
                        <th>ç®±å­å·</th>
                        <th>äº§å“è´§å·</th>
                        <th>å›¾ç‰‡URL</th>
                        <th>æ˜ å°„è¯´æ˜</th>
                    </tr>
                </thead>
                <tbody id="previewTable"></tbody>
            </table>
        </div>
    </div>

    <script>
        // ============================================
        // é…ç½®
        // ============================================
        const GITHUB_USERNAME = "huamaohuanyu";
        const GITHUB_REPO = "packinglist-system";
        const GITHUB_BRANCH = "main";
        const GITHUB_BASE_URL = `https://github.com/${GITHUB_USERNAME}/${GITHUB_REPO}/raw/${GITHUB_BRANCH}/images/`;

        // å­˜å‚¨æ‰¹æ¬¡
        let batches = [];

        // å­˜å‚¨äº§å“æ‰¹æ¬¡
        let productBatches = [];

        // ä»æ–‡æœ¬ç”Ÿæˆé…ç½®
        function generateFromText() {
            const input = document.getElementById('boxNumbersInput').value.trim();
            if (!input) {
                alert('è¯·è¾“å…¥ç®±å­å·ï¼');
                return;
            }

            const boxNumbers = input.split('\n').map(line => line.trim()).filter(line => line);
            generateConfig(boxNumbers);
        }

        // æ‰¹é‡ç”Ÿæˆé…ç½®
        function generateBatch() {
            const prefix = document.getElementById('boxPrefix').value.trim();
            const startNum = parseInt(document.getElementById('startNumber').value);
            const endNum = parseInt(document.getElementById('endNumber').value);
            const digits = parseInt(document.getElementById('digitCount').value);
            const mappingType = document.getElementById('imageMappingType').value;
            const groupConfig = document.getElementById('imageGroupConfig').value.trim();
            const manualConfig = document.getElementById('manualMappingConfig').value.trim();

            if (!prefix || isNaN(startNum) || isNaN(endNum) || isNaN(digits)) {
                alert('è¯·å¡«å†™å®Œæ•´çš„ä¿¡æ¯ï¼');
                return;
            }

            if (startNum > endNum) {
                alert('èµ·å§‹ç¼–å·ä¸èƒ½å¤§äºç»“æŸç¼–å·ï¼');
                return;
            }

            const boxNumbers = [];
            for (let i = startNum; i <= endNum; i++) {
                const num = String(i).padStart(digits, '0');
                boxNumbers.push(prefix + num);
            }

            // ç”Ÿæˆå›¾ç‰‡æ˜ å°„
            const imageMapping = generateImageMapping(boxNumbers, mappingType, groupConfig, manualConfig);

            // æ·»åŠ åˆ°æ‰¹æ¬¡åˆ—è¡¨ï¼ˆåŒ…å«å›¾ç‰‡æ˜ å°„ä¿¡æ¯ï¼‰
            const batchName = `${prefix}${startNum}-${endNum} (${boxNumbers.length}ç®±, ${imageMapping.uniqueImages}å¼ å›¾ç‰‡)`;
            batches.push({
                name: batchName,
                boxNumbers: boxNumbers,
                imageMapping: imageMapping.mapping,
                mappingType: imageMapping.mappingTypeDescription
            });

            updateBatchList();
            generateConfigWithMapping(boxNumbers, imageMapping.mapping, imageMapping.mappingTypeDescription);
            alert(`æˆåŠŸç”Ÿæˆ ${boxNumbers.length} ä¸ªç®±å­é…ç½®ï¼åªéœ€ ${imageMapping.uniqueImages} å¼ å›¾ç‰‡ï¼`);
        }

        // ç”Ÿæˆå›¾ç‰‡æ˜ å°„
        function generateImageMapping(boxNumbers, mappingType, groupConfig, manualConfig) {
            const mapping = {};
            let uniqueImages = 0;
            let mappingTypeDescription = ''; // ç”¨äºç”Ÿæˆä»£ç æ—¶çš„æ³¨é‡Š

            if (mappingType === 'same') {
                // å…¨éƒ¨ä½¿ç”¨ç¬¬ä¸€å¼ å›¾ç‰‡
                const firstBox = boxNumbers[0];
                boxNumbers.forEach(boxNum => {
                    mapping[boxNum] = firstBox;
                });
                uniqueImages = 1;
                mappingTypeDescription = 'å…¨éƒ¨ä½¿ç”¨ç¬¬ä¸€å¼ å›¾ç‰‡';

            } else if (mappingType === 'manual' && manualConfig && manualConfig.trim()) {
                // æ‰‹åŠ¨æŒ‡å®šæ˜ å°„ï¼ˆæ–°åŠŸèƒ½ï¼šæ”¯æŒä¸å‡åŒ€åˆ†é…ï¼‰
                const lines = manualConfig.split('\n')
                    .map(line => line.trim())
                    .filter(line => line && line.includes('='));

                lines.forEach(line => {
                    const parts = line.split('=');
                    if (parts.length >= 2) {
                        const boxNumber = parts[0].trim();
                        const imageFile = parts[1].trim();

                        // éªŒè¯ç®±å­å·æ˜¯å¦åœ¨å½“å‰æ‰¹æ¬¡ä¸­
                        if (boxNumbers.includes(boxNumber)) {
                            // éªŒè¯å›¾ç‰‡æ–‡ä»¶åä¸ä¸ºç©º
                            if (imageFile) {
                                mapping[boxNumber] = imageFile;
                            }
                        }
                    }
                });

                // ä¸ºæœªæ‰‹åŠ¨æŒ‡å®šçš„ç®±å­ä½¿ç”¨é»˜è®¤æ˜ å°„ï¼ˆè‡ªå·±ï¼‰
                boxNumbers.forEach(boxNum => {
                    if (!mapping[boxNum]) {
                        mapping[boxNum] = boxNum;
                    }
                });

                uniqueImages = new Set(Object.values(mapping)).size;
                mappingTypeDescription = 'æ‰‹åŠ¨æŒ‡å®šæ˜ å°„';

            } else if (groupConfig && groupConfig.trim()) {
                // æŒ‰è¿ç»­èŒƒå›´åˆ†ç»„ï¼ˆæ—§æ–¹å¼ï¼‰
                const groups = groupConfig.split('\n')
                    .map(line => line.trim())
                    .filter(line => line && line.includes('-'))
                    .map(line => {
                        const parts = line.split('-');
                        return {
                            start: parseInt(parts[0]),
                            end: parseInt(parts[1])
                        };
                    })
                    .filter(group => !isNaN(group.start) && !isNaN(group.end));

                // ä¸ºæ¯ä¸ªç®±å­åˆ†é…å›¾ç‰‡
                boxNumbers.forEach(boxNum => {
                    const boxNumber = parseInt(boxNum.replace(/\D/g, '')); // æå–æ•°å­—

                    // æŸ¥æ‰¾ç®±å­æ‰€å±çš„ç»„
                    const group = groups.find(g => boxNumber >= g.start && boxNumber <= g.end);

                    if (group) {
                        // ä½¿ç”¨è¯¥ç»„çš„ç¬¬ä¸€å¼ å›¾ç‰‡
                        const firstBoxInGroup = boxNumbers.find(b => parseInt(b.replace(/\D/g, '')) === group.start);
                        mapping[boxNum] = firstBoxInGroup || boxNum;
                    } else {
                        // æ²¡æœ‰æ‰¾åˆ°ç»„ï¼Œä½¿ç”¨è‡ªå·±çš„å›¾ç‰‡
                        mapping[boxNum] = boxNum;
                    }
                });

                uniqueImages = new Set(Object.values(mapping)).size;
                mappingTypeDescription = 'æŒ‰è¿ç»­èŒƒå›´åˆ†ç»„';

            } else {
                // æ¯ä¸ªç®±å­ç‹¬ç«‹å›¾ç‰‡
                boxNumbers.forEach(boxNum => {
                    mapping[boxNum] = boxNum;
                });
                uniqueImages = boxNumbers.length;
                mappingTypeDescription = 'æ¯ä¸ªç®±å­ç‹¬ç«‹å›¾ç‰‡';
            }

            return { mapping, uniqueImages, mappingTypeDescription };
        }

        // æ˜¾ç¤ºæ‰¹æ¬¡è¾“å…¥
        function showBatchInput() {
            const prefix = prompt('è¯·è¾“å…¥ç®±å­å‰ç¼€ï¼ˆå¦‚ï¼šCMEX-ï¼‰ï¼š', 'CMEX-');
            if (!prefix) return;

            const startNum = prompt('è¯·è¾“å…¥èµ·å§‹ç¼–å·ï¼ˆå¦‚ï¼š1ï¼‰ï¼š', '1');
            if (!startNum) return;

            const endNum = prompt('è¯·è¾“å…¥ç»“æŸç¼–å·ï¼ˆå¦‚ï¼š10ï¼‰ï¼š', '10');
            if (!endNum) return;

            const digits = prompt('è¯·è¾“å…¥ç¼–å·ä½æ•°ï¼ˆå¦‚ï¼š3ä½=001ï¼Œ2ä½=01ï¼‰ï¼š', '3');
            if (!digits) return;

            // è¯¢é—®å›¾ç‰‡æ˜ å°„æ–¹å¼
            const mappingType = prompt('è¯·é€‰æ‹©å›¾ç‰‡æ˜ å°„æ–¹å¼ï¼ˆè¾“å…¥æ•°å­—ï¼‰ï¼š\n1 - å…¨éƒ¨ä½¿ç”¨ç¬¬ä¸€å¼ å›¾ç‰‡ï¼ˆæœ€çœï¼‰\n2 - æ‰‹åŠ¨æŒ‡å®šæ˜ å°„ï¼ˆçµæ´»ï¼‰\n3 - æ¯ä¸ªç®±å­ç‹¬ç«‹å›¾ç‰‡', '1');
            if (!mappingType) return;

            const boxNumbers = [];
            for (let i = parseInt(startNum); i <= parseInt(endNum); i++) {
                const num = String(i).padStart(parseInt(digits), '0');
                boxNumbers.push(prefix + num);
            }

            // ç”Ÿæˆè¯¥æ‰¹æ¬¡çš„å›¾ç‰‡æ˜ å°„
            let imageMapping = {};
            let mappingTypeDescription = '';
            let manualConfig = '';
            let groupConfig = '';

            if (mappingType === '1') {
                // å…¨éƒ¨ä½¿ç”¨ç¬¬ä¸€å¼ å›¾ç‰‡
                const firstBox = boxNumbers[0];
                boxNumbers.forEach(boxNum => {
                    imageMapping[boxNum] = firstBox;
                });
                mappingTypeDescription = 'å…¨éƒ¨ä½¿ç”¨ç¬¬ä¸€å¼ å›¾ç‰‡';

            } else if (mappingType === '2') {
                // æ‰‹åŠ¨æŒ‡å®šæ˜ å°„
                manualConfig = prompt(`è¯·è¾“å…¥æ‰‹åŠ¨æ˜ å°„é…ç½®ï¼ˆæ¯è¡Œæ ¼å¼ï¼šç®±å­å·=å›¾ç‰‡æ–‡ä»¶åï¼‰\nä¾‹å¦‚ï¼š\n${prefix}001=${prefix}001\n${prefix}002=${prefix}001\n${prefix}003=${prefix}001\n${prefix}004=${prefix}004\n${prefix}005=${prefix}004`, '');
                if (manualConfig !== null) {
                    const lines = manualConfig.split('\n')
                        .map(line => line.trim())
                        .filter(line => line && line.includes('='));

                    lines.forEach(line => {
                        const parts = line.split('=');
                        if (parts.length >= 2) {
                            const boxNumber = parts[0].trim();
                            const imageFile = parts[1].trim();
                            if (boxNumbers.includes(boxNumber) && imageFile) {
                                imageMapping[boxNumber] = imageFile;
                            }
                        }
                    });

                    // ä¸ºæœªæ‰‹åŠ¨æŒ‡å®šçš„ç®±å­ä½¿ç”¨é»˜è®¤æ˜ å°„
                    boxNumbers.forEach(boxNum => {
                        if (!imageMapping[boxNum]) {
                            imageMapping[boxNum] = boxNum;
                        }
                    });
                    mappingTypeDescription = 'æ‰‹åŠ¨æŒ‡å®šæ˜ å°„';
                } else {
                    // ç”¨æˆ·å–æ¶ˆï¼Œä½¿ç”¨é»˜è®¤æ˜ å°„
                    boxNumbers.forEach(boxNum => {
                        imageMapping[boxNum] = boxNum;
                    });
                    mappingTypeDescription = 'æ¯ä¸ªç®±å­ç‹¬ç«‹å›¾ç‰‡';
                }

            } else {
                // æ¯ä¸ªç®±å­ç‹¬ç«‹å›¾ç‰‡
                boxNumbers.forEach(boxNum => {
                    imageMapping[boxNum] = boxNum;
                });
                mappingTypeDescription = 'æ¯ä¸ªç®±å­ç‹¬ç«‹å›¾ç‰‡';
            }

            const uniqueImages = new Set(Object.values(imageMapping)).size;
            const batchName = `${prefix}${startNum}-${endNum} (${boxNumbers.length}ç®±, ${uniqueImages}å¼ å›¾ç‰‡)`;

            batches.push({
                name: batchName,
                boxNumbers: boxNumbers,
                imageMapping: imageMapping,
                mappingType: mappingTypeDescription
            });

            updateBatchList();
            alert(`æ‰¹æ¬¡ "${batchName}" å·²æ·»åŠ ï¼\næ˜ å°„æ–¹å¼ï¼š${mappingTypeDescription}\néœ€è¦ ${uniqueImages} å¼ å›¾ç‰‡ã€‚`);
        }

        // æ›´æ–°æ‰¹æ¬¡åˆ—è¡¨
        function updateBatchList() {
            const batchListDiv = document.getElementById('batchList');
            if (batches.length === 0) {
                batchListDiv.innerHTML = '<p>æš‚æ— æ‰¹æ¬¡</p>';
                return;
            }

            let html = '<ul>';
            batches.forEach((batch, index) => {
                const mappingInfo = batch.mappingType ? `<span style="color:#1976d2;font-size:12px;">(${batch.mappingType})</span>` : '';
                const uniqueImages = batch.imageMapping ? new Set(Object.values(batch.imageMapping)).size : batch.boxNumbers.length;
                html += `<li><strong>${batch.name}</strong> - ${batch.boxNumbers.length} ç®±, ${uniqueImages} å¼ å›¾ç‰‡ ${mappingInfo} <button onclick="removeBatch(${index})" style="margin-left:10px;padding:5px 10px;font-size:12px;">åˆ é™¤</button></li>`;
            });
            html += '</ul>';

            // è®¡ç®—æ€»ç®±æ•°å’Œæ€»å›¾ç‰‡æ•°
            const totalBoxes = batches.reduce((sum, b) => sum + b.boxNumbers.length, 0);
            const totalImages = batches.reduce((sum, b) => {
                if (b.imageMapping && Object.keys(b.imageMapping).length > 0) {
                    return sum + new Set(Object.values(b.imageMapping)).size;
                }
                return sum + b.boxNumbers.length;
            }, 0);

            html += `<p style="margin-top:10px;"><strong>æ€»è®¡ï¼š${batches.length} ä¸ªæ‰¹æ¬¡ï¼Œ${totalBoxes} ç®±ï¼Œ${totalImages} å¼ å›¾ç‰‡</strong></p>`;
            batchListDiv.innerHTML = html;
        }

        // åˆ é™¤æ‰¹æ¬¡
        function removeBatch(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ‰¹æ¬¡å—ï¼Ÿ')) {
                batches.splice(index, 1);
                updateBatchList();
            }
        }

        // æ¸…ç©ºæ‰€æœ‰æ‰¹æ¬¡
        function clearBatches() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ‰¹æ¬¡å—ï¼Ÿ')) {
                batches = [];
                updateBatchList();
            }
        }

        // åˆå¹¶æ‰€æœ‰æ‰¹æ¬¡
        function mergeBatches() {
            if (batches.length === 0) {
                alert('æ²¡æœ‰æ‰¹æ¬¡å¯åˆå¹¶ï¼');
                return;
            }

            const allBoxNumbers = [];
            const mergedImageMapping = {};

            // é‡æ–°ç”Ÿæˆåˆå¹¶åçš„å›¾ç‰‡æ˜ å°„
            // æ¯ä¸ªæ‰¹æ¬¡ç‹¬ç«‹å¤„ç†è‡ªå·±çš„æ˜ å°„
            batches.forEach(batch => {
                const startIndex = allBoxNumbers.length;
                allBoxNumbers.push(...batch.boxNumbers);

                // å¦‚æœæ‰¹æ¬¡æœ‰è‡ªå®šä¹‰æ˜ å°„ï¼Œéœ€è¦è°ƒæ•´ç´¢å¼•
                if (batch.imageMapping && Object.keys(batch.imageMapping).length > 0) {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯"å…¨éƒ¨ä½¿ç”¨ç¬¬ä¸€å¼ å›¾ç‰‡"æ¨¡å¼
                    const batchFirstBox = batch.boxNumbers[0];
                    const allUseFirst = batch.boxNumbers.every(boxNum => 
                        batch.imageMapping[boxNum] === batchFirstBox
                    );

                    if (allUseFirst && batch.mappingType === 'å…¨éƒ¨ä½¿ç”¨ç¬¬ä¸€å¼ å›¾ç‰‡') {
                        // å…¨éƒ¨ä½¿ç”¨è¯¥æ‰¹æ¬¡çš„ç¬¬ä¸€å¼ å›¾ç‰‡
                        batch.boxNumbers.forEach(boxNum => {
                            mergedImageMapping[boxNum] = batchFirstBox;
                        });
                    } else {
                        // ä½¿ç”¨åŸå§‹æ˜ å°„
                        Object.assign(mergedImageMapping, batch.imageMapping);
                    }
                }
            });

            // è®¡ç®—å®é™…éœ€è¦çš„å›¾ç‰‡æ•°é‡
            const uniqueImages = new Set(Object.values(mergedImageMapping)).size;
            const totalBoxes = allBoxNumbers.length;
            const mappingTypeDescription = uniqueImages === 1 ? 'æ‰€æœ‰æ‰¹æ¬¡ç»Ÿä¸€ä½¿ç”¨ç¬¬ä¸€å¼ å›¾ç‰‡' : 'å¤šæ‰¹æ¬¡åˆå¹¶ï¼ˆç‹¬ç«‹æ˜ å°„ï¼‰';

            generateConfigWithMapping(allBoxNumbers, mergedImageMapping, mappingTypeDescription);
            alert(`æˆåŠŸåˆå¹¶ ${batches.length} ä¸ªæ‰¹æ¬¡ï¼Œå…± ${allBoxNumbers.length} ç®±ï¼Œéœ€è¦ ${uniqueImages} å¼ å›¾ç‰‡ï¼`);
        }

        // ç”Ÿæˆé…ç½®ä»£ç ï¼ˆå¸¦å›¾ç‰‡æ˜ å°„ï¼‰
        function generateConfigWithMapping(boxNumbers, imageMapping, mappingTypeDescription = '') {
            let code = `// Lista de nÃºmeros de paquete\n`;
            code += `const packingLists = [\n`;

            boxNumbers.forEach((boxNumber, index) => {
                const comma = index < boxNumbers.length - 1 ? ',' : '';
                code += `    "${boxNumber}"${comma}\n`;
            });

            code += `];\n\n`;

            // ç”Ÿæˆå›¾ç‰‡æ˜ å°„ä»£ç 
            code += `// Mapeo de imÃ¡genes - ${mappingTypeDescription}\n`;

            // åªç”Ÿæˆæœ‰æ˜ å°„çš„ç®±å­ï¼ˆéè‡ªèº«æ˜ å°„ï¼‰
            const mappedBoxes = boxNumbers.filter(boxNum => imageMapping[boxNum] !== boxNum);

            if (mappedBoxes.length === 0) {
                // æ¯ä¸ªç®±å­ç‹¬ç«‹å›¾ç‰‡
                code += `// Cada caja usa su propia imagen (no se requiere mapeo)\n`;
                code += `const imageMapping = {};\n`;
            } else {
                // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰ç®±å­éƒ½æ˜ å°„åˆ°åŒä¸€å¼ å›¾ç‰‡
                const uniqueImages = new Set(Object.values(imageMapping)).size;
                const firstBox = boxNumbers[0];
                const allMapToFirst = boxNumbers.every(boxNum => imageMapping[boxNum] === firstBox);

                if (allMapToFirst && uniqueImages === 1) {
                    // æ‰€æœ‰ç®±å­éƒ½æ˜ å°„åˆ°ç¬¬ä¸€å¼ å›¾ç‰‡ï¼šç”Ÿæˆç®€æ´çš„é…ç½®
                    code += `// Todos los paquetes usan la misma imagen (${firstBox}.jpg)\n`;
                    code += `// Solo necesita preparar 1 imagen: ${firstBox}.jpg\n`;
                    code += `const imageMapping = {\n`;
                    // åŠ¨æ€ç”Ÿæˆç¤ºä¾‹ç®±å­å·
                    const sampleBoxes = boxNumbers.slice(1, 4);
                    sampleBoxes.forEach((boxNum, idx) => {
                        const isLast = idx === sampleBoxes.length - 1;
                        const comma = isLast ? '' : ',';
                        code += `    "${boxNum}": "${firstBox}"${comma}\n`;
                    });
                    if (boxNumbers.length > 4) {
                        code += `    // ... (todos los demÃ¡s paquetes)\n`;
                        code += `    "${boxNumbers[boxNumbers.length - 1]}": "${firstBox}"\n`;
                    }
                    code += `};\n\n`;
                    code += `// Nota: TambiÃ©n puede dejar el imageMapping vacÃ­o {} y solo preparar ${firstBox}.jpg\n`;
                } else {
                    // éƒ¨åˆ†ç®±å­ä½¿ç”¨æ˜ å°„
                    code += `const imageMapping = {\n`;
                    mappedBoxes.forEach((boxNumber, index) => {
                        const imageFile = imageMapping[boxNumber];
                        const comment = boxNumber !== imageFile ? `// Usa imagen de ${imageFile}` : '';
                        const comma = index < mappedBoxes.length - 1 ? ',' : '';
                        code += `    "${boxNumber}": "${imageFile}", ${comment}\n`;
                    });
                    code += `};`;
                }
            }

            document.getElementById('outputCode').value = code;

            // æ˜¾ç¤ºé¢„è§ˆè¡¨æ ¼ï¼ˆåŒ…å«å›¾ç‰‡æ˜ å°„ä¿¡æ¯ï¼‰
            const tbody = document.getElementById('previewTable');
            tbody.innerHTML = '';

            boxNumbers.forEach((boxNumber, index) => {
                const imageFile = imageMapping[boxNumber] || boxNumber;
                const isMapped = imageFile !== boxNumber;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${boxNumber}</td>
                    <td><a href="${GITHUB_BASE_URL}${imageFile}.jpg" target="_blank">${GITHUB_BASE_URL}${imageFile}.jpg</a></td>
                    <td>${isMapped ? '<span style="color:#27ae60;">âœ… æ˜ å°„åˆ° ' + imageFile + '</span>' : '<span style="color:#666;">ç‹¬ç«‹å›¾ç‰‡</span>'}</td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('previewSection').style.display = 'block';
        }

        // ç”Ÿæˆé…ç½®ä»£ç ï¼ˆæ—§ç‰ˆæœ¬ï¼Œä¿æŒå…¼å®¹ï¼‰
        function generateConfig(boxNumbers) {
            generateConfigWithMapping(boxNumbers, {});
        }

        // å¤åˆ¶é…ç½®ä»£ç 
        function copyCode() {
            const textarea = document.getElementById('outputCode');
            textarea.select();
            document.execCommand('copy');
            alert('é…ç½®ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
        }

        // ä¸‹è½½é…ç½®æ–‡ä»¶
        function downloadCode() {
            const code = document.getElementById('outputCode').value;
            if (!code) {
                alert('æ²¡æœ‰å¯ä¸‹è½½çš„å†…å®¹ï¼');
                return;
            }

            const blob = new Blob([code], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'packingLists-config.txt';
            a.click();
            URL.revokeObjectURL(url);
        }

        // æ¸…ç©ºè¾“å‡º
        function clearOutput() {
            document.getElementById('outputCode').value = '';
            document.getElementById('previewTable').innerHTML = '';
            document.getElementById('previewSection').style.display = 'none';
        }

        // ç›‘å¬æ˜ å°„ç±»å‹å˜åŒ–ï¼Œæ˜¾ç¤º/éšè—å¯¹åº”è®¾ç½®
        document.addEventListener('DOMContentLoaded', function() {
            const mappingTypeSelect = document.getElementById('imageMappingType');
            const manualSettings = document.getElementById('manualMappingSettings');
            const groupSettings = document.getElementById('imageGroupSettings');

            mappingTypeSelect.addEventListener('change', function() {
                if (this.value === 'manual') {
                    manualSettings.style.display = 'block';
                    groupSettings.style.display = 'none';
                } else if (this.value === 'same' || this.value === 'individual') {
                    manualSettings.style.display = 'none';
                    groupSettings.style.display = 'none';
                }
            });
        });

        // è‡ªåŠ¨å¡«å……ç¤ºä¾‹æ˜ å°„
        function autoFillMapping() {
            const prefix = document.getElementById('boxPrefix').value.trim();
            const startNum = parseInt(document.getElementById('startNumber').value);
            const endNum = parseInt(document.getElementById('endNumber').value);
            const digits = parseInt(document.getElementById('digitCount').value);

            if (!prefix || isNaN(startNum) || isNaN(endNum) || isNaN(digits)) {
                alert('è¯·å…ˆå¡«å†™ç®±å­å‰ç¼€å’Œç¼–å·èŒƒå›´ï¼');
                return;
            }

            const totalBoxes = endNum - startNum + 1;
            if (totalBoxes < 3) {
                alert('ç®±å­æ•°é‡è‡³å°‘éœ€è¦3ä¸ªæ‰èƒ½ç”Ÿæˆç¤ºä¾‹æ˜ å°„ï¼');
                return;
            }

            // ç”Ÿæˆç¤ºä¾‹æ˜ å°„ï¼šå‰3ç®±ç”¨ç¬¬1å¼ å›¾ï¼Œä¸­é—´5ç®±ç”¨ç¬¬4å¼ å›¾ï¼Œå‰©ä½™ç”¨ç¬¬9å¼ å›¾
            let manualMapping = '';
            let boxNum = 1;

            while (boxNum <= totalBoxes) {
                const boxNumber = `${prefix}${String(startNum + boxNum - 1).padStart(digits, '0')}`;

                // å‰ä¸‰ç®±ç”¨ç¬¬ä¸€å¼ å›¾
                if (boxNum <= 3) {
                    const firstBox = `${prefix}${String(startNum).padStart(digits, '0')}`;
                    manualMapping += `${boxNumber}=${firstBox}\n`;
                }
                // ä¸­é—´äº”ç®±ç”¨ç¬¬å››å¼ å›¾
                else if (boxNum >= 4 && boxNum <= 8) {
                    const fourthBox = `${prefix}${String(startNum + 3).padStart(digits, '0')}`;
                    manualMapping += `${boxNumber}=${fourthBox}\n`;
                }
                // å‰©ä½™çš„ç”¨ç¬¬9å¼ å›¾ï¼ˆå¦‚æœæœ‰ï¼‰
                else {
                    const ninthBox = `${prefix}${String(startNum + 8).padStart(digits, '0')}`;
                    manualMapping += `${boxNumber}=${ninthBox}\n`;
                }

                boxNum++;
            }

            document.getElementById('manualMappingConfig').value = manualMapping;
            alert('å·²è‡ªåŠ¨å¡«å……ç¤ºä¾‹æ˜ å°„ï¼æ‚¨å¯ä»¥æ ¹æ®å®é™…éœ€æ±‚ä¿®æ”¹ã€‚');
        }

        // è‡ªåŠ¨å¡«å……äº§å“æ‰¹æ¬¡ç¤ºä¾‹
        function autoFillProductBatches() {
            productBatches = [];
            const prefix = "CMEX-";
            const digits = 3;

            // ç”Ÿæˆ5ä¸ªäº§å“æ‰¹æ¬¡çš„ç¤ºä¾‹
            productBatches.push({
                productCode: "1169",
                boxPrefix: prefix,
                startNum: 1,
                endNum: 3,
                digits: digits
            });

            productBatches.push({
                productCode: "1170",
                boxPrefix: prefix,
                startNum: 4,
                endNum: 8,
                digits: digits
            });

            productBatches.push({
                productCode: "1171",
                boxPrefix: prefix,
                startNum: 9,
                endNum: 10,
                digits: digits
            });

            productBatches.push({
                productCode: "1172",
                boxPrefix: prefix,
                startNum: 11,
                endNum: 13,
                digits: digits
            });

            productBatches.push({
                productCode: "1173",
                boxPrefix: prefix,
                startNum: 14,
                endNum: 15,
                digits: digits
            });

            updateProductBatchList();
            alert('å·²è‡ªåŠ¨å¡«å……5ä¸ªäº§å“æ‰¹æ¬¡ç¤ºä¾‹ï¼');
        }

        // æ·»åŠ äº§å“æ‰¹æ¬¡
        function addProductBatch() {
            const productCode = document.getElementById('productCode').value.trim();
            const boxPrefix = document.getElementById('boxPrefix4').value.trim();
            const startNum = parseInt(document.getElementById('startNumber4').value);
            const endNum = parseInt(document.getElementById('endNumber4').value);
            const digits = parseInt(document.getElementById('digitCount4').value);

            if (!productCode) {
                alert('è¯·è¾“å…¥äº§å“è´§å·ï¼');
                return;
            }

            if (!boxPrefix) {
                alert('è¯·è¾“å…¥ç®±å­å‰ç¼€ï¼');
                return;
            }

            if (isNaN(startNum) || isNaN(endNum) || isNaN(digits)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ç¼–å·ä¿¡æ¯ï¼');
                return;
            }

            if (startNum > endNum) {
                alert('èµ·å§‹ç¼–å·ä¸èƒ½å¤§äºç»“æŸç¼–å·ï¼');
                return;
            }

            // è®¡ç®—ç®±æ•°
            const boxCount = endNum - startNum + 1;

            // æ·»åŠ åˆ°æ‰¹æ¬¡åˆ—è¡¨
            productBatches.push({
                productCode: productCode,
                boxPrefix: boxPrefix,
                startNum: startNum,
                endNum: endNum,
                digits: digits
            });

            updateProductBatchList();
            alert(`å·²æ·»åŠ æ‰¹æ¬¡ï¼šäº§å“ ${productCode}ï¼Œ${boxCount} ç®±ï¼ˆ${boxPrefix}${String(startNum).padStart(digits, '0')} ~ ${boxPrefix}${String(endNum).padStart(digits, '0')}ï¼‰`);
        }

        // æ›´æ–°äº§å“æ‰¹æ¬¡åˆ—è¡¨æ˜¾ç¤º
        function updateProductBatchList() {
            const batchListDiv = document.getElementById('productBatchList');
            if (productBatches.length === 0) {
                batchListDiv.innerHTML = '<p style="font-size: 12px; color: #999;">æš‚æ— æ‰¹æ¬¡</p>';
                return;
            }

            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 10px;">';
            productBatches.forEach((batch, index) => {
                const boxCount = batch.endNum - batch.startNum + 1;
                html += `
                    <div style="background: #fff; padding: 10px; border: 1px solid #ddd; border-radius: 6px; border-left: 4px solid #1976d2;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <strong style="color: #1976d2;">äº§å“ ${batch.productCode}</strong>
                            <button onclick="removeProductBatch(${index})" style="background: #e74c3c; color: white; border: none; padding: 3px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">åˆ é™¤</button>
                        </div>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">
                            ${batch.boxPrefix}${String(batch.startNum).padStart(batch.digits, '0')} ~
                            ${batch.boxPrefix}${String(batch.endNum).padStart(batch.digits, '0')}
                            ï¼ˆ${boxCount} ç®±ï¼‰
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            // è®¡ç®—æ€»è®¡
            const totalBoxes = productBatches.reduce((sum, b) => sum + (b.endNum - b.startNum + 1), 0);
            const totalProducts = productBatches.length;

            html += `<div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #1976d2;">
                <strong>æ€»è®¡ï¼š${totalProducts} ä¸ªäº§å“ï¼Œ${totalBoxes} ç®±ï¼Œéœ€è¦ ${totalProducts} å¼ å›¾ç‰‡</strong>
            </div>`;

            batchListDiv.innerHTML = html;
        }

        // åˆ é™¤äº§å“æ‰¹æ¬¡
        function removeProductBatch(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ‰¹æ¬¡å—ï¼Ÿ')) {
                productBatches.splice(index, 1);
                updateProductBatchList();
            }
        }

        // æ¸…ç©ºæ‰€æœ‰äº§å“æ‰¹æ¬¡
        function clearProductBatches() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ‰¹æ¬¡å—ï¼Ÿ')) {
                productBatches = [];
                updateProductBatchList();
            }
        }

        // ä»äº§å“æ‰¹æ¬¡ç”Ÿæˆé…ç½®
        function generateProductMappingFromBatches() {
            if (productBatches.length === 0) {
                alert('è¯·å…ˆæ·»åŠ äº§å“æ‰¹æ¬¡ï¼');
                return;
            }

            // æ”¶é›†æ‰€æœ‰ç®±å­å·
            const allBoxNumbers = [];
            const productMapping = {};

            // éå†æ¯ä¸ªæ‰¹æ¬¡ï¼Œç”Ÿæˆç®±å­å·å’Œæ˜ å°„
            productBatches.forEach(batch => {
                for (let i = batch.startNum; i <= batch.endNum; i++) {
                    const boxNumber = `${batch.boxPrefix}${String(i).padStart(batch.digits, '0')}`;
                    allBoxNumbers.push(boxNumber);
                    // æ˜ å°„åˆ°äº§å“è´§å·
                    productMapping[boxNumber] = batch.productCode;
                }
            });

            // è®¡ç®—äº§å“æ•°é‡ï¼ˆå»é‡ï¼‰
            const uniqueProducts = new Set(productBatches.map(b => b.productCode)).size;

            // ç”Ÿæˆé…ç½®ä»£ç 
            let code = `// Lista de nÃºmeros de paquete\n`;
            code += `const packingLists = [\n`;

            allBoxNumbers.forEach((boxNumber, index) => {
                const comma = index < allBoxNumbers.length - 1 ? ',' : '';
                code += `    "${boxNumber}"${comma}\n`;
            });

            code += `];\n\n`;

            // ç”Ÿæˆäº§å“è´§å·æ˜ å°„ä»£ç 
            code += `// Mapeo de producto (Caja -> CÃ³digo de Producto)\n`;
            code += `// ${allBoxNumbers.length} cajas, ${uniqueProducts} productos Ãºnicos\n`;
            code += `const productMapping = {\n`;

            // åªç”Ÿæˆæœ‰äº§å“è´§å·æ˜ å°„çš„ç®±å­
            Object.keys(productMapping).forEach((boxNumber, index) => {
                const productCode = productMapping[boxNumber];
                const comma = index < Object.keys(productMapping).length - 1 ? ',' : '';
                code += `    "${boxNumber}": "${productCode}"${comma}  // Producto: ${productCode}\n`;
            });

            code += `};\n\n`;

            code += `// Nota: Solo necesita preparar las imÃ¡genes de los productos (${uniqueProducts} imÃ¡genes):\n`;
            productBatches.forEach(batch => {
                code += `// - ${batch.productCode}.jpg  (Cajas: ${batch.boxPrefix}${String(batch.startNum).padStart(batch.digits, '0')} ~ ${batch.boxPrefix}${String(batch.endNum).padStart(batch.digits, '0')})\n`;
            });

            code += `\n// Ejemplo de uso:\n`;
            code += `// Si la caja CMEX-001 mapea al producto 1169,\n`;
            code += `// se mostrarÃ¡ la imagen: ${GITHUB_BASE_URL}1169.jpg\n`;

            document.getElementById('outputCode').value = code;

            // æ˜¾ç¤ºé¢„è§ˆè¡¨æ ¼ï¼ˆåŒ…å«äº§å“è´§å·ä¿¡æ¯ï¼‰
            const tbody = document.getElementById('previewTable');
            tbody.innerHTML = '';

            allBoxNumbers.forEach((boxNumber, index) => {
                const productCode = productMapping[boxNumber];
                const imageUrl = `${GITHUB_BASE_URL}${productCode}.jpg`;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${boxNumber}</td>
                    <td style="font-weight:bold; color:#1976d2;">${productCode}</td>
                    <td><a href="${imageUrl}" target="_blank">${imageUrl}</a></td>
                    <td><span style="color:#27ae60;">âœ… äº§å“ ${productCode}</span></td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('previewSection').style.display = 'block';
            alert(`æˆåŠŸç”Ÿæˆ ${allBoxNumbers.length} ä¸ªç®±å­é…ç½®ï¼åªéœ€å‡†å¤‡ ${uniqueProducts} å¼ äº§å“å›¾ç‰‡ï¼`);
        }
    </script>
</body>
</html>
